<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DLPerf Analysis Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-regression@2.0.0/dist/chartjs-plugin-regression.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            text-align: center;
        }

        h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 1.1em;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
            margin: 10px 0;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .chart-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .chart-title {
            font-size: 1.5em;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
            margin-bottom: 20px;
        }

        .insights {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .insight-item {
            padding: 15px;
            margin: 10px 0;
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            border-radius: 5px;
        }

        .correlation-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .correlation-table th,
        .correlation-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .correlation-table th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }

        .correlation-table tr:hover {
            background: #f8f9fa;
        }

        .correlation-value {
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 5px;
            display: inline-block;
        }

        .correlation-high {
            background: #4caf50;
            color: white;
        }

        .correlation-medium {
            background: #ff9800;
            color: white;
        }

        .correlation-low {
            background: #f44336;
            color: white;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: white;
            font-size: 1.2em;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ðŸš€ DLPerf Analysis Dashboard</h1>
            <p class="subtitle">Deep Learning Performance Correlation Analysis</p>
        </header>

        <div id="loading" class="loading">
            Loading and analyzing data...
        </div>

        <div id="content" style="display: none;">
            <!-- Statistics Cards -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Total Instances</div>
                    <div class="stat-value" id="total-instances">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Avg DLPerf</div>
                    <div class="stat-value" id="avg-dlperf">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Max DLPerf</div>
                    <div class="stat-value" id="max-dlperf">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Min DLPerf</div>
                    <div class="stat-value" id="min-dlperf">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Std Deviation</div>
                    <div class="stat-value" id="std-dlperf">-</div>
                </div>
            </div>

            <!-- Correlation Table -->
            <div class="chart-container">
                <h2 class="chart-title">ðŸ“Š Correlation Matrix</h2>
                <table class="correlation-table">
                    <thead>
                        <tr>
                            <th>Specification</th>
                            <th>Correlation with DLPerf</th>
                            <th>Strength</th>
                        </tr>
                    </thead>
                    <tbody id="correlation-table-body">
                    </tbody>
                </table>
            </div>

            <!-- Scatter Plots -->
            <div class="grid-2">
                <div class="chart-container">
                    <h2 class="chart-title">Price per Hour vs DLPerf</h2>
                    <div class="chart-wrapper">
                        <canvas id="price-chart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <h2 class="chart-title">TFLOPS vs DLPerf</h2>
                    <div class="chart-wrapper">
                        <canvas id="tflops-chart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <h2 class="chart-title">GPU RAM vs DLPerf</h2>
                    <div class="chart-wrapper">
                        <canvas id="gpu-ram-chart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <h2 class="chart-title">GPU Memory Bandwidth vs DLPerf</h2>
                    <div class="chart-wrapper">
                        <canvas id="gpu-mem-bw-chart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <h2 class="chart-title">Number of GPUs vs DLPerf</h2>
                    <div class="chart-wrapper">
                        <canvas id="num-gpus-chart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <h2 class="chart-title">CPU Cores vs DLPerf</h2>
                    <div class="chart-wrapper">
                        <canvas id="cpu-cores-chart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <h2 class="chart-title">PCIe Bandwidth vs DLPerf</h2>
                    <div class="chart-wrapper">
                        <canvas id="pcie-bw-chart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <h2 class="chart-title">Compute Capability vs DLPerf</h2>
                    <div class="chart-wrapper">
                        <canvas id="compute-cap-chart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Distribution Charts -->
            <div class="grid-2">
                <div class="chart-container">
                    <h2 class="chart-title">DLPerf Distribution</h2>
                    <div class="chart-wrapper">
                        <canvas id="dlperf-distribution"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <h2 class="chart-title">DLPerf by GPU Model</h2>
                    <div class="chart-wrapper" style="height: 600px;">
                        <canvas id="gpu-model-chart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Insights -->
            <div class="insights">
                <h2 class="chart-title">ðŸ’¡ Key Insights</h2>
                <div id="insights-content"></div>
            </div>
        </div>
    </div>

    <script>
        let data = [];
        let charts = {};

        // Load data
        fetch('offers.json')
            .then(response => response.json())
            .then(jsonData => {
                data = jsonData.filter(item => item.dlperf != null && item.dlperf > 0);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';
                analyzeData();
            })
            .catch(error => {
                console.error('Error loading data:', error);
                document.getElementById('loading').innerHTML = 'Error loading data. Please check that offers.json exists.';
            });

        function calculateCorrelation(x, y) {
            const n = x.length;
            if (n === 0) return 0;

            const sumX = x.reduce((a, b) => a + b, 0);
            const sumY = y.reduce((a, b) => a + b, 0);
            const sumXY = x.reduce((sum, xi, i) => sum + xi * y[i], 0);
            const sumX2 = x.reduce((sum, xi) => sum + xi * xi, 0);
            const sumY2 = y.reduce((sum, yi) => sum + yi * yi, 0);

            const numerator = n * sumXY - sumX * sumY;
            const denominator = Math.sqrt((n * sumX2 - sumX * sumX) * (n * sumY2 - sumY * sumY));

            return denominator === 0 ? 0 : numerator / denominator;
        }

        function getCorrelationStrength(corr) {
            const abs = Math.abs(corr);
            if (abs >= 0.7) return { label: 'Strong', class: 'correlation-high' };
            if (abs >= 0.4) return { label: 'Medium', class: 'correlation-medium' };
            return { label: 'Weak', class: 'correlation-low' };
        }

        function analyzeData() {
            // Calculate statistics
            const dlperfValues = data.map(d => d.dlperf);
            const avg = dlperfValues.reduce((a, b) => a + b, 0) / dlperfValues.length;
            const max = Math.max(...dlperfValues);
            const min = Math.min(...dlperfValues);
            const variance = dlperfValues.reduce((sum, val) => sum + Math.pow(val - avg, 2), 0) / dlperfValues.length;
            const std = Math.sqrt(variance);

            document.getElementById('total-instances').textContent = data.length.toLocaleString();
            document.getElementById('avg-dlperf').textContent = avg.toFixed(2);
            document.getElementById('max-dlperf').textContent = max.toFixed(2);
            document.getElementById('min-dlperf').textContent = min.toFixed(2);
            document.getElementById('std-dlperf').textContent = std.toFixed(2);

            // Calculate correlations
            const specs = [
                { key: 'dph_total', label: 'Price per Hour ($)', getValue: d => d.dph_total },
                { key: 'total_flops', label: 'TFLOPS', getValue: d => d.total_flops },
                { key: 'gpu_ram', label: 'GPU RAM (MB)', getValue: d => d.gpu_ram },
                { key: 'gpu_mem_bw', label: 'GPU Memory Bandwidth (GB/s)', getValue: d => d.gpu_mem_bw },
                { key: 'num_gpus', label: 'Number of GPUs', getValue: d => d.num_gpus },
                { key: 'cpu_cores', label: 'CPU Cores', getValue: d => d.cpu_cores },
                { key: 'cpu_cores_effective', label: 'CPU Cores (Effective)', getValue: d => d.cpu_cores_effective },
                { key: 'cpu_ghz', label: 'CPU GHz', getValue: d => d.cpu_ghz },
                { key: 'cpu_ram', label: 'CPU RAM (GB)', getValue: d => d.cpu_ram },
                { key: 'pcie_bw', label: 'PCIe Bandwidth (GB/s)', getValue: d => d.pcie_bw },
                { key: 'compute_cap', label: 'Compute Capability', getValue: d => d.compute_cap },
                { key: 'disk_bw', label: 'Disk Bandwidth (MB/s)', getValue: d => d.disk_bw },
                { key: 'gpu_max_power', label: 'GPU Max Power (W)', getValue: d => d.gpu_max_power },
            ];

            const correlations = [];
            const dlperfArray = data.map(d => d.dlperf);

            specs.forEach(spec => {
                const specValues = data.map(spec.getValue).filter(v => v != null && !isNaN(v));
                const dlperfFiltered = data
                    .map((d, i) => ({ dlperf: d.dlperf, spec: spec.getValue(d) }))
                    .filter(d => d.spec != null && !isNaN(d.spec))
                    .map(d => d.dlperf);

                if (specValues.length > 10 && dlperfFiltered.length === specValues.length) {
                    const corr = calculateCorrelation(specValues, dlperfFiltered);
                    correlations.push({ ...spec, correlation: corr, count: specValues.length });
                }
            });

            correlations.sort((a, b) => Math.abs(b.correlation) - Math.abs(a.correlation));

            // Populate correlation table
            const tableBody = document.getElementById('correlation-table-body');
            tableBody.innerHTML = '';
            correlations.forEach(spec => {
                const strength = getCorrelationStrength(spec.correlation);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${spec.label}</td>
                    <td><span class="correlation-value ${strength.class}">${spec.correlation.toFixed(3)}</span></td>
                    <td>${strength.label}</td>
                `;
                tableBody.appendChild(row);
            });

            // Create scatter plots
            createScatterChart('price-chart', 'Price per Hour ($)', data.map(d => d.dph_total), dlperfValues);
            createScatterChart('tflops-chart', 'TFLOPS', data.map(d => d.total_flops), dlperfValues);
            createScatterChart('gpu-ram-chart', 'GPU RAM (MB)', data.map(d => d.gpu_ram), dlperfValues);
            createScatterChart('gpu-mem-bw-chart', 'GPU Memory Bandwidth (GB/s)', data.map(d => d.gpu_mem_bw), dlperfValues);
            createScatterChart('num-gpus-chart', 'Number of GPUs', data.map(d => d.num_gpus), dlperfValues);
            createScatterChart('cpu-cores-chart', 'CPU Cores', data.map(d => d.cpu_cores), dlperfValues);
            createScatterChart('pcie-bw-chart', 'PCIe Bandwidth (GB/s)', data.map(d => d.pcie_bw), dlperfValues);
            createScatterChart('compute-cap-chart', 'Compute Capability', data.map(d => d.compute_cap), dlperfValues);

            // Create distribution chart
            createDistributionChart();

            // Create GPU model chart
            createGPUModelChart();

            // Generate insights
            generateInsights(correlations, avg, max, min);
        }

        function createScatterChart(canvasId, xLabel, xData, yData) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            
            // Filter out null/undefined values
            const filtered = xData.map((x, i) => ({ x, y: yData[i] }))
                .filter(d => d.x != null && !isNaN(d.x) && d.y != null && !isNaN(d.y));
            
            const xFiltered = filtered.map(d => d.x);
            const yFiltered = filtered.map(d => d.y);
            const corr = calculateCorrelation(xFiltered, yFiltered);

            if (charts[canvasId]) {
                charts[canvasId].destroy();
            }

            charts[canvasId] = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: `Correlation: ${corr.toFixed(3)}`,
                        data: filtered,
                        backgroundColor: 'rgba(102, 126, 234, 0.6)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${xLabel}: ${context.parsed.x.toFixed(2)}, DLPerf: ${context.parsed.y.toFixed(2)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: xLabel
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'DLPerf Score'
                            }
                        }
                    }
                }
            });
        }

        function createDistributionChart() {
            const ctx = document.getElementById('dlperf-distribution').getContext('2d');
            const dlperfValues = data.map(d => d.dlperf);
            
            // Create bins with nice round numbers
            const min = Math.min(...dlperfValues);
            const max = Math.max(...dlperfValues);
            
            // Determine a nice bin size
            const range = max - min;
            let binSize = 100; // Default to 100
            if (range > 5000) binSize = 500;
            else if (range > 2000) binSize = 200;
            else if (range > 1000) binSize = 100;
            else if (range > 500) binSize = 50;
            else binSize = 25;
            
            // Calculate bins starting from a rounded minimum
            const minRounded = Math.floor(min / binSize) * binSize;
            const maxRounded = Math.ceil(max / binSize) * binSize;
            const binCount = Math.ceil((maxRounded - minRounded) / binSize);
            
            const bins = Array(binCount).fill(0);
            const labels = [];

            for (let i = 0; i < binCount; i++) {
                const start = minRounded + i * binSize;
                const end = start + binSize;
                labels.push(`${start}-${end}`);
            }

            dlperfValues.forEach(val => {
                const binIndex = Math.min(Math.floor((val - minRounded) / binSize), binCount - 1);
                if (binIndex >= 0 && binIndex < binCount) {
                    bins[binIndex]++;
                }
            });

            if (charts['dlperf-distribution']) {
                charts['dlperf-distribution'].destroy();
            }

            charts['dlperf-distribution'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Number of Instances',
                        data: bins,
                        backgroundColor: 'rgba(102, 126, 234, 0.7)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'DLPerf Score Range'
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45,
                                autoSkip: true,
                                maxTicksLimit: 20
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Frequency'
                            },
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function createGPUModelChart() {
            const ctx = document.getElementById('gpu-model-chart').getContext('2d');
            
            // Group by GPU model
            const gpuGroups = {};
            data.forEach(d => {
                if (d.gpu_name) {
                    if (!gpuGroups[d.gpu_name]) {
                        gpuGroups[d.gpu_name] = [];
                    }
                    gpuGroups[d.gpu_name].push(d.dlperf);
                }
            });

            // Calculate averages and sort
            const gpuStats = Object.entries(gpuGroups)
                .map(([name, values]) => ({
                    name,
                    avg: values.reduce((a, b) => a + b, 0) / values.length,
                    count: values.length,
                    min: Math.min(...values),
                    max: Math.max(...values)
                }))
                .filter(g => g.count >= 3) // Only show GPUs with at least 3 instances
                .sort((a, b) => b.avg - a.avg)
                .slice(0, 20); // Top 20

            if (charts['gpu-model-chart']) {
                charts['gpu-model-chart'].destroy();
            }

            charts['gpu-model-chart'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: gpuStats.map(g => g.name),
                    datasets: [{
                        label: 'Average DLPerf',
                        data: gpuStats.map(g => g.avg),
                        backgroundColor: 'rgba(102, 126, 234, 0.7)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    const gpu = gpuStats[context.dataIndex];
                                    return `Instances: ${gpu.count} | Range: ${gpu.min.toFixed(0)} - ${gpu.max.toFixed(0)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Average DLPerf Score'
                            },
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function generateInsights(correlations, avg, max, min) {
            const insights = [];
            
            // Top correlations
            const topPositive = correlations.filter(c => c.correlation > 0).slice(0, 3);
            const topNegative = correlations.filter(c => c.correlation < 0).slice(0, 3);

            insights.push(`<div class="insight-item"><strong>Strongest Positive Correlations:</strong> ${topPositive.map(c => `${c.label} (${c.correlation.toFixed(3)})`).join(', ')}</div>`);
            
            if (topNegative.length > 0) {
                insights.push(`<div class="insight-item"><strong>Strongest Negative Correlations:</strong> ${topNegative.map(c => `${c.label} (${c.correlation.toFixed(3)})`).join(', ')}</div>`);
            }

            // GPU model insights
            const gpuGroups = {};
            data.forEach(d => {
                if (d.gpu_name) {
                    if (!gpuGroups[d.gpu_name]) {
                        gpuGroups[d.gpu_name] = [];
                    }
                    gpuGroups[d.gpu_name].push(d.dlperf);
                }
            });

            const gpuStats = Object.entries(gpuGroups)
                .map(([name, values]) => ({
                    name,
                    avg: values.reduce((a, b) => a + b, 0) / values.length,
                    count: values.length
                }))
                .filter(g => g.count >= 5)
                .sort((a, b) => b.avg - a.avg);

            if (gpuStats.length > 0) {
                insights.push(`<div class="insight-item"><strong>Best Performing GPU:</strong> ${gpuStats[0].name} with average DLPerf of ${gpuStats[0].avg.toFixed(2)} (${gpuStats[0].count} instances)</div>`);
            }

            // Range insights
            const range = max - min;
            insights.push(`<div class="insight-item"><strong>DLPerf Range:</strong> ${min.toFixed(2)} to ${max.toFixed(2)} (span of ${range.toFixed(2)})</div>`);

            // Percentile insights
            const sorted = data.map(d => d.dlperf).sort((a, b) => a - b);
            const p50 = sorted[Math.floor(sorted.length * 0.5)];
            const p75 = sorted[Math.floor(sorted.length * 0.75)];
            const p90 = sorted[Math.floor(sorted.length * 0.9)];

            insights.push(`<div class="insight-item"><strong>Percentiles:</strong> Median (50th): ${p50.toFixed(2)}, 75th: ${p75.toFixed(2)}, 90th: ${p90.toFixed(2)}</div>`);

            document.getElementById('insights-content').innerHTML = insights.join('');
        }
    </script>
</body>
</html>
